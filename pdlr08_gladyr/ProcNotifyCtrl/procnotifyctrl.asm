; Listing generated by Microsoft (R) Optimizing Compiler Version 15.00.30729.207 

	TITLE	c:\radasm\wdk\projects\driver_projects\pdlr08_gladyr\procnotifyctrl\procnotifyctrl.c
	.686P
	.XMM
	include listing.inc
	.model	flat

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	_serviceName
PUBLIC	_symbolicLinkName
PUBLIC	_imageName
_DATA	SEGMENT
_serviceName DB	'ProcessNotify', 00H
	ORG $+2
_symbolicLinkName DB '\\.\ProcessNotify', 00H
	ORG $+2
_imageName DB	'ProcessNotify.sys', 00H
_DATA	ENDS
PUBLIC	??_C@_0BI@LGCNFJIL@?6Press?5?8Enter?8?5to?5exit?6?$AA@ ; `string'
PUBLIC	??_C@_0CN@JEBFDAOH@?6Can?8t?5delete?5service?5?8?$CFs?8?4?5Erro@ ; `string'
PUBLIC	??_C@_0BG@HLANJPHO@?6Service?5?8?$CFs?8?5deleted?$AA@ ; `string'
PUBLIC	??_C@_0CL@DNLIHKOL@?6Can?8t?5stop?5service?5?8?$CFs?8?4?5ErrorC@ ; `string'
PUBLIC	??_C@_0BG@GNCMMNDN@?6Service?5?8?$CFs?8?5stopped?$AA@ ; `string'
PUBLIC	??_C@_0CH@NDEDPMI@?6IOCTL_START?5failed?4?5ErrorCode?$DN0@ ; `string'
PUBLIC	??_C@_0CM@CBBEMDPD@?6Module?5?$CFws?5loaded?5at?5imagebase?5@ ; `string'
PUBLIC	??_C@_0BI@OHLBBEAH@?6Process?5PID?5?$DN?5?$CFd?5?$CFs?5?$CFs?$AA@ ; `string'
PUBLIC	??_C@_08CDECDFO@finished?$AA@			; `string'
PUBLIC	??_C@_07ELEPLNCO@started?$AA@			; `string'
PUBLIC	??_C@_0DD@BPCEGHIK@?6Try?5to?5create?5two?5processes?5and@ ; `string'
PUBLIC	??_C@_0DB@HNPALFON@?6Can?8t?5open?5symbolik?5link?5?8?$CFs?8?4?5@ ; `string'
PUBLIC	??_C@_0CN@NIILNDPD@?6Can?8t?5start?5service?5?8?$CFs?8?4?5Error@ ; `string'
PUBLIC	??_C@_0BO@FMFCEEJB@?6Service?5?8?$CFs?8?5already?5running?$AA@ ; `string'
PUBLIC	??_C@_0BG@KCIEGIHK@?6Service?5?8?$CFs?8?5started?$AA@ ; `string'
PUBLIC	??_C@_0CN@LJAJMOLA@?6Can?8t?5create?5service?5?8?$CFs?8?4?5Erro@ ; `string'
PUBLIC	??_C@_0BG@BDOMDCP@?6Service?5?8?$CFs?8?5created?$AA@ ; `string'
PUBLIC	??_C@_0DO@DMADPKCI@?6Can?8t?5get?5full?5path?5for?5service@ ; `string'
PUBLIC	??_C@_0DJ@MAJKNFIF@?6Can?8t?5open?5service?5?8?$CFs?8?4?5ErrorC@ ; `string'
PUBLIC	??_C@_0BF@HJJJKPCP@?6Service?5?8?$CFs?8?5opened?$AA@ ; `string'
PUBLIC	??_C@_0DF@NHKGILHH@?6Can?8t?5open?5Service?5Control?5Mana@ ; `string'
PUBLIC	??_C@_0CI@HECGKNGL@?6CreateEvent?5fails?5with?5errorCod@ ; `string'
PUBLIC	??_C@_0BO@OGPOAGEO@?O?p?n?c?p?$OA?l?$OA?5?s?o?p?$OA?b?k?$LD?m?m?$PP?5?d?p?$OA?i?b?e?p?n?l?$AA@ ; `string'
PUBLIC	__$ArrayPad$
PUBLIC	_main
EXTRN	__imp__getchar:PROC
EXTRN	__imp__CloseServiceHandle@4:PROC
EXTRN	__imp__DeleteService@4:PROC
EXTRN	__imp__ControlService@12:PROC
EXTRN	__imp__CloseHandle@4:PROC
EXTRN	__imp__WaitForMultipleObjects@16:PROC
EXTRN	__imp__DeviceIoControl@32:PROC
EXTRN	__imp__CreateFileA@28:PROC
EXTRN	__imp__StartServiceA@12:PROC
EXTRN	__imp__CreateServiceA@52:PROC
EXTRN	__imp__GetFullPathNameA@16:PROC
EXTRN	__imp__OpenServiceA@12:PROC
EXTRN	__imp__OpenSCManagerA@12:PROC
EXTRN	__imp__printf:PROC
EXTRN	__imp__GetLastError@0:PROC
EXTRN	__imp__CreateEventA@16:PROC
EXTRN	__imp__SetConsoleTitleA@4:PROC
EXTRN	___security_cookie:DWORD
EXTRN	@__security_check_cookie@4:PROC
EXTRN	__chkstk:PROC
EXTRN	_memset:PROC
;	COMDAT ??_C@_0BI@LGCNFJIL@?6Press?5?8Enter?8?5to?5exit?6?$AA@
; File c:\radasm\wdk\projects\driver_projects\pdlr08_gladyr\procnotifyctrl\procnotifyctrl.c
CONST	SEGMENT
??_C@_0BI@LGCNFJIL@?6Press?5?8Enter?8?5to?5exit?6?$AA@ DB 0aH, 'Press ''E'
	DB	'nter'' to exit', 0aH, 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_0CN@JEBFDAOH@?6Can?8t?5delete?5service?5?8?$CFs?8?4?5Erro@
CONST	SEGMENT
??_C@_0CN@JEBFDAOH@?6Can?8t?5delete?5service?5?8?$CFs?8?4?5Erro@ DB 0aH, 'C'
	DB	'an''t delete service ''%s''. ErrorCode=0x%0X.', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0BG@HLANJPHO@?6Service?5?8?$CFs?8?5deleted?$AA@
CONST	SEGMENT
??_C@_0BG@HLANJPHO@?6Service?5?8?$CFs?8?5deleted?$AA@ DB 0aH, 'Service '''
	DB	'%s'' deleted', 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0CL@DNLIHKOL@?6Can?8t?5stop?5service?5?8?$CFs?8?4?5ErrorC@
CONST	SEGMENT
??_C@_0CL@DNLIHKOL@?6Can?8t?5stop?5service?5?8?$CFs?8?4?5ErrorC@ DB 0aH, 'C'
	DB	'an''t stop service ''%s''. ErrorCode=0x%0X.', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0BG@GNCMMNDN@?6Service?5?8?$CFs?8?5stopped?$AA@
CONST	SEGMENT
??_C@_0BG@GNCMMNDN@?6Service?5?8?$CFs?8?5stopped?$AA@ DB 0aH, 'Service '''
	DB	'%s'' stopped', 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0CH@NDEDPMI@?6IOCTL_START?5failed?4?5ErrorCode?$DN0@
CONST	SEGMENT
??_C@_0CH@NDEDPMI@?6IOCTL_START?5failed?4?5ErrorCode?$DN0@ DB 0aH, 'IOCTL'
	DB	'_START failed. ErrorCode=0x%08X.', 00H	; `string'
CONST	ENDS
;	COMDAT ??_C@_0CM@CBBEMDPD@?6Module?5?$CFws?5loaded?5at?5imagebase?5@
CONST	SEGMENT
??_C@_0CM@CBBEMDPD@?6Module?5?$CFws?5loaded?5at?5imagebase?5@ DB 0aH, 'Mo'
	DB	'dule %ws loaded at imagebase %p size: %p', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0BI@OHLBBEAH@?6Process?5PID?5?$DN?5?$CFd?5?$CFs?5?$CFs?$AA@
CONST	SEGMENT
??_C@_0BI@OHLBBEAH@?6Process?5PID?5?$DN?5?$CFd?5?$CFs?5?$CFs?$AA@ DB 0aH, 'P'
	DB	'rocess PID = %d %s %s', 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_08CDECDFO@finished?$AA@
CONST	SEGMENT
??_C@_08CDECDFO@finished?$AA@ DB 'finished', 00H	; `string'
CONST	ENDS
;	COMDAT ??_C@_07ELEPLNCO@started?$AA@
CONST	SEGMENT
??_C@_07ELEPLNCO@started?$AA@ DB 'started', 00H		; `string'
CONST	ENDS
;	COMDAT ??_C@_0DD@BPCEGHIK@?6Try?5to?5create?5two?5processes?5and@
CONST	SEGMENT
??_C@_0DD@BPCEGHIK@?6Try?5to?5create?5two?5processes?5and@ DB 0aH, 'Try t'
	DB	'o create two processes and then finish them', 0aH, 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0DB@HNPALFON@?6Can?8t?5open?5symbolik?5link?5?8?$CFs?8?4?5@
CONST	SEGMENT
??_C@_0DB@HNPALFON@?6Can?8t?5open?5symbolik?5link?5?8?$CFs?8?4?5@ DB 0aH, 'C'
	DB	'an''t open symbolik link ''%s''. ErrorCode=0x%0X.', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0CN@NIILNDPD@?6Can?8t?5start?5service?5?8?$CFs?8?4?5Error@
CONST	SEGMENT
??_C@_0CN@NIILNDPD@?6Can?8t?5start?5service?5?8?$CFs?8?4?5Error@ DB 0aH, 'C'
	DB	'an''t start service ''%s''. ErrorCode=0x%08X.', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0BO@FMFCEEJB@?6Service?5?8?$CFs?8?5already?5running?$AA@
CONST	SEGMENT
??_C@_0BO@FMFCEEJB@?6Service?5?8?$CFs?8?5already?5running?$AA@ DB 0aH, 'S'
	DB	'ervice ''%s'' already running', 00H		; `string'
CONST	ENDS
;	COMDAT ??_C@_0BG@KCIEGIHK@?6Service?5?8?$CFs?8?5started?$AA@
CONST	SEGMENT
??_C@_0BG@KCIEGIHK@?6Service?5?8?$CFs?8?5started?$AA@ DB 0aH, 'Service '''
	DB	'%s'' started', 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0CN@LJAJMOLA@?6Can?8t?5create?5service?5?8?$CFs?8?4?5Erro@
CONST	SEGMENT
??_C@_0CN@LJAJMOLA@?6Can?8t?5create?5service?5?8?$CFs?8?4?5Erro@ DB 0aH, 'C'
	DB	'an''t create service ''%s''. ErrorCode=0x%0X.', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0BG@BDOMDCP@?6Service?5?8?$CFs?8?5created?$AA@
CONST	SEGMENT
??_C@_0BG@BDOMDCP@?6Service?5?8?$CFs?8?5created?$AA@ DB 0aH, 'Service ''%'
	DB	's'' created', 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0DO@DMADPKCI@?6Can?8t?5get?5full?5path?5for?5service@
CONST	SEGMENT
??_C@_0DO@DMADPKCI@?6Can?8t?5get?5full?5path?5for?5service@ DB 0aH, 'Can'''
	DB	't get full path for service image ''%s''. ErrorCode=0x%0X.', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0DJ@MAJKNFIF@?6Can?8t?5open?5service?5?8?$CFs?8?4?5ErrorC@
CONST	SEGMENT
??_C@_0DJ@MAJKNFIF@?6Can?8t?5open?5service?5?8?$CFs?8?4?5ErrorC@ DB 0aH, 'C'
	DB	'an''t open service ''%s''. ErrorCode=0x%0X.', 0aH, 'Try creat'
	DB	'e...', 00H					; `string'
CONST	ENDS
;	COMDAT ??_C@_0BF@HJJJKPCP@?6Service?5?8?$CFs?8?5opened?$AA@
CONST	SEGMENT
??_C@_0BF@HJJJKPCP@?6Service?5?8?$CFs?8?5opened?$AA@ DB 0aH, 'Service ''%'
	DB	's'' opened', 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0DF@NHKGILHH@?6Can?8t?5open?5Service?5Control?5Mana@
CONST	SEGMENT
??_C@_0DF@NHKGILHH@?6Can?8t?5open?5Service?5Control?5Mana@ DB 0aH, 'Can'''
	DB	't open Service Control Manager. ErrorCode=0x%0X', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0CI@HECGKNGL@?6CreateEvent?5fails?5with?5errorCod@
CONST	SEGMENT
??_C@_0CI@HECGKNGL@?6CreateEvent?5fails?5with?5errorCod@ DB 0aH, 'CreateE'
	DB	'vent fails with errorCode=0x%0X', 00H	; `string'
CONST	ENDS
;	COMDAT ??_C@_0BO@OGPOAGEO@?O?p?n?c?p?$OA?l?$OA?5?s?o?p?$OA?b?k?$LD?m?m?$PP?5?d?p?$OA?i?b?e?p?n?l?$AA@
CONST	SEGMENT
??_C@_0BO@OGPOAGEO@?O?p?n?c?p?$OA?l?$OA?5?s?o?p?$OA?b?k?$LD?m?m?$PP?5?d?p?$OA?i?b?e?p?n?l?$AA@ DB 0cfH
	DB	0f0H, 0eeH, 0e3H, 0f0H, 0e0H, 0ecH, 0e0H, ' ', 0f3H, 0efH, 0f0H
	DB	0e0H, 0e2H, 0ebH, 0b3H, 0edH, 0edH, 0ffH, ' ', 0e4H, 0f0H, 0e0H
	DB	0e9H, 0e2H, 0e5H, 0f0H, 0eeH, 0ecH, 00H	; `string'
; Function compile flags: /Odtp
CONST	ENDS
;	COMDAT _main
_TEXT	SEGMENT
tv250 = -131696						; size = 4
tv236 = -131692						; size = 4
_statusBefore$ = -131688				; size = 4
_lastError$ = -131684					; size = 4
_outputImageBuffer$ = -131680				; size = 131080
_event$ = -600						; size = 8
_counterProcess$ = -592					; size = 4
_serviceStatus$ = -588					; size = 28
_counterBytes$ = -560					; size = 4
_waitResult$ = -556					; size = 4
_scm$ = -552						; size = 4
_service$ = -548					; size = 4
_outputBuffer$ = -544					; size = 12
_device$ = -532						; size = 4
_fullImagePath$ = -528					; size = 520
__$ArrayPad$ = -4					; size = 4
_main	PROC						; COMDAT

; 4    : {

	npad	2
	push	ebp
	mov	ebp, esp
	mov	eax, 131696				; 00020270H
	call	__chkstk
	mov	eax, DWORD PTR ___security_cookie
	xor	eax, ebp
	mov	DWORD PTR __$ArrayPad$[ebp], eax

; 5    : 	HANDLE					scm = NULL;

	mov	DWORD PTR _scm$[ebp], 0

; 6    : 	HANDLE					service = NULL;

	mov	DWORD PTR _service$[ebp], 0

; 7    : 	HANDLE					device = INVALID_HANDLE_VALUE;

	mov	DWORD PTR _device$[ebp], -1

; 8    : 	DWORD					counterBytes = 0, counterProcess = 0;

	mov	DWORD PTR _counterBytes$[ebp], 0
	mov	DWORD PTR _counterProcess$[ebp], 0

; 9    : 	DWORD					lastError = ERROR_SUCCESS;

	mov	DWORD PTR _lastError$[ebp], 0

; 10   : 	DWORD					statusBefore = SERVICE_NOT_INSTALLED;

	mov	DWORD PTR _statusBefore$[ebp], 0

; 11   : 	TCHAR					fullImagePath[2*MAX_PATH] = {0};

	mov	BYTE PTR _fullImagePath$[ebp], 0
	push	519					; 00000207H
	push	0
	lea	eax, DWORD PTR _fullImagePath$[ebp+1]
	push	eax
	call	_memset
	add	esp, 12					; 0000000cH

; 12   : 	SERVICE_STATUS			serviceStatus = {0};

	mov	DWORD PTR _serviceStatus$[ebp], 0
	xor	ecx, ecx
	mov	DWORD PTR _serviceStatus$[ebp+4], ecx
	mov	DWORD PTR _serviceStatus$[ebp+8], ecx
	mov	DWORD PTR _serviceStatus$[ebp+12], ecx
	mov	DWORD PTR _serviceStatus$[ebp+16], ecx
	mov	DWORD PTR _serviceStatus$[ebp+20], ecx
	mov	DWORD PTR _serviceStatus$[ebp+24], ecx

; 13   : 	HANDLE					event[2]  = {NULL};

	mov	DWORD PTR _event$[ebp], 0
	xor	edx, edx
	mov	DWORD PTR _event$[ebp+4], edx

; 14   : 	PROCESS_NOTIFY_INFO	outputBuffer = {0};

	mov	DWORD PTR _outputBuffer$[ebp], 0
	xor	eax, eax
	mov	DWORD PTR _outputBuffer$[ebp+4], eax
	mov	DWORD PTR _outputBuffer$[ebp+8], eax

; 15   : 	IMAGE_NOTIFY_INFO		outputImageBuffer = {0};

	mov	DWORD PTR _outputImageBuffer$[ebp], 0
	push	131076					; 00020004H
	push	0
	lea	ecx, DWORD PTR _outputImageBuffer$[ebp+4]
	push	ecx
	call	_memset
	add	esp, 12					; 0000000cH

; 16   : 	DWORD					waitResult = 0;

	mov	DWORD PTR _waitResult$[ebp], 0

; 17   : 	
; 18   : 	SetConsoleTitle(_TEXT("Програма управління драйвером"));

	push	OFFSET ??_C@_0BO@OGPOAGEO@?O?p?n?c?p?$OA?l?$OA?5?s?o?p?$OA?b?k?$LD?m?m?$PP?5?d?p?$OA?i?b?e?p?n?l?$AA@
	call	DWORD PTR __imp__SetConsoleTitleA@4

; 19   : 	
; 20   : 	event[0] = CreateEvent(NULL, FALSE, FALSE, NULL);

	push	0
	push	0
	push	0
	push	0
	call	DWORD PTR __imp__CreateEventA@16
	mov	DWORD PTR _event$[ebp], eax

; 21   : 	if(!event[0])

	cmp	DWORD PTR _event$[ebp], 0
	jne	SHORT $LN35@main

; 22   : 	{
; 23   : 		lastError = GetLastError();

	call	DWORD PTR __imp__GetLastError@0
	mov	DWORD PTR _lastError$[ebp], eax

; 24   : 		_tprintf(_TEXT("\nCreateEvent fails with errorCode=0x%0X"), lastError);

	mov	edx, DWORD PTR _lastError$[ebp]
	push	edx
	push	OFFSET ??_C@_0CI@HECGKNGL@?6CreateEvent?5fails?5with?5errorCod@
	call	DWORD PTR __imp__printf
	add	esp, 8

; 25   : 		return lastError;

	mov	eax, DWORD PTR _lastError$[ebp]
	jmp	$LN36@main
$LN35@main:

; 26   : 	}
; 27   : 	
; 28   : 	event[1] = CreateEvent(NULL, FALSE, FALSE, NULL);

	push	0
	push	0
	push	0
	push	0
	call	DWORD PTR __imp__CreateEventA@16
	mov	DWORD PTR _event$[ebp+4], eax

; 29   : 	if(!event[1])

	cmp	DWORD PTR _event$[ebp+4], 0
	jne	SHORT $LN34@main

; 30   : 	{
; 31   : 		lastError = GetLastError();

	call	DWORD PTR __imp__GetLastError@0
	mov	DWORD PTR _lastError$[ebp], eax

; 32   : 		_tprintf(_TEXT("\nCreateEvent fails with errorCode=0x%0X"), lastError);

	mov	eax, DWORD PTR _lastError$[ebp]
	push	eax
	push	OFFSET ??_C@_0CI@HECGKNGL@?6CreateEvent?5fails?5with?5errorCod@
	call	DWORD PTR __imp__printf
	add	esp, 8

; 33   : 		return lastError;

	mov	eax, DWORD PTR _lastError$[ebp]
	jmp	$LN36@main
$LN34@main:

; 34   : 	}
; 35   : 	
; 36   : 	scm = OpenSCManager(NULL, NULL, SC_MANAGER_ALL_ACCESS);

	push	983103					; 000f003fH
	push	0
	push	0
	call	DWORD PTR __imp__OpenSCManagerA@12
	mov	DWORD PTR _scm$[ebp], eax

; 37   : 	if(!scm)

	cmp	DWORD PTR _scm$[ebp], 0
	jne	SHORT $LN33@main

; 38   : 	{
; 39   : 		lastError = GetLastError();

	call	DWORD PTR __imp__GetLastError@0
	mov	DWORD PTR _lastError$[ebp], eax

; 40   : 		_tprintf(_TEXT("\nCan't open Service Control Manager. ErrorCode=0x%0X"), lastError);

	mov	ecx, DWORD PTR _lastError$[ebp]
	push	ecx
	push	OFFSET ??_C@_0DF@NHKGILHH@?6Can?8t?5open?5Service?5Control?5Mana@
	call	DWORD PTR __imp__printf
	add	esp, 8

; 41   : 		return lastError;

	mov	eax, DWORD PTR _lastError$[ebp]
	jmp	$LN36@main
$LN33@main:

; 42   : 	}
; 43   : 
; 44   : 	service = OpenService(scm, serviceName,	SERVICE_START + SERVICE_STOP);

	push	48					; 00000030H
	push	OFFSET _serviceName
	mov	edx, DWORD PTR _scm$[ebp]
	push	edx
	call	DWORD PTR __imp__OpenServiceA@12
	mov	DWORD PTR _service$[ebp], eax

; 45   : 	if(service)

	cmp	DWORD PTR _service$[ebp], 0
	je	SHORT $LN32@main

; 46   : 	{
; 47   : 		statusBefore |= SERVICE_OPENED;

	mov	eax, DWORD PTR _statusBefore$[ebp]
	or	eax, 8
	mov	DWORD PTR _statusBefore$[ebp], eax

; 48   : 		_tprintf(_TEXT("\nService '%s' opened"), serviceName);

	push	OFFSET _serviceName
	push	OFFSET ??_C@_0BF@HJJJKPCP@?6Service?5?8?$CFs?8?5opened?$AA@
	call	DWORD PTR __imp__printf
	add	esp, 8

; 49   : 	}
; 50   : 	else

	jmp	$LN31@main
$LN32@main:

; 51   : 	{
; 52   : 		_tprintf(_TEXT("\nCan't open service '%s'. ErrorCode=0x%0X.\nTry create..."), 
; 53   : 					serviceName, GetLastError());

	call	DWORD PTR __imp__GetLastError@0
	push	eax
	push	OFFSET _serviceName
	push	OFFSET ??_C@_0DJ@MAJKNFIF@?6Can?8t?5open?5service?5?8?$CFs?8?4?5ErrorC@
	call	DWORD PTR __imp__printf
	add	esp, 12					; 0000000cH

; 54   : 		counterBytes = GetFullPathName(
; 55   : 								imageName,
; 56   : 								sizeof (fullImagePath)/sizeof(TCHAR), 
; 57   : 								fullImagePath, NULL);

	push	0
	lea	ecx, DWORD PTR _fullImagePath$[ebp]
	push	ecx
	push	520					; 00000208H
	push	OFFSET _imageName
	call	DWORD PTR __imp__GetFullPathNameA@16
	mov	DWORD PTR _counterBytes$[ebp], eax

; 58   : 		if(counterBytes == 0 || counterBytes > sizeof (fullImagePath)/sizeof(TCHAR))

	cmp	DWORD PTR _counterBytes$[ebp], 0
	je	SHORT $LN29@main
	cmp	DWORD PTR _counterBytes$[ebp], 520	; 00000208H
	jbe	SHORT $LN30@main
$LN29@main:

; 59   : 		{
; 60   : 			lastError = GetLastError();

	call	DWORD PTR __imp__GetLastError@0
	mov	DWORD PTR _lastError$[ebp], eax

; 61   : 			_tprintf(_TEXT("\nCan't get full path for service image '%s'. ErrorCode=0x%0X."), 
; 62   : 						imageName, lastError);

	mov	edx, DWORD PTR _lastError$[ebp]
	push	edx
	push	OFFSET _imageName
	push	OFFSET ??_C@_0DO@DMADPKCI@?6Can?8t?5get?5full?5path?5for?5service@
	call	DWORD PTR __imp__printf
	add	esp, 12					; 0000000cH

; 63   : 		}
; 64   : 		else

	jmp	$LN31@main
$LN30@main:

; 65   : 		{
; 66   : 			service = CreateService(
; 67   : 							scm,
; 68   : 							serviceName,
; 69   : 							serviceName,
; 70   : 							SERVICE_START + SERVICE_STOP + DELETE,
; 71   : 							SERVICE_KERNEL_DRIVER,
; 72   : 							SERVICE_DEMAND_START,
; 73   : 							SERVICE_ERROR_IGNORE,
; 74   : 							fullImagePath,
; 75   : 							NULL, NULL, NULL, NULL, NULL);

	push	0
	push	0
	push	0
	push	0
	push	0
	lea	eax, DWORD PTR _fullImagePath$[ebp]
	push	eax
	push	0
	push	3
	push	1
	push	65584					; 00010030H
	push	OFFSET _serviceName
	push	OFFSET _serviceName
	mov	ecx, DWORD PTR _scm$[ebp]
	push	ecx
	call	DWORD PTR __imp__CreateServiceA@52
	mov	DWORD PTR _service$[ebp], eax

; 76   : 			if(service)

	cmp	DWORD PTR _service$[ebp], 0
	je	SHORT $LN27@main

; 77   : 			{
; 78   : 				statusBefore |= SERVICE_INSTALLED;

	mov	edx, DWORD PTR _statusBefore$[ebp]
	or	edx, 1
	mov	DWORD PTR _statusBefore$[ebp], edx

; 79   : 				_tprintf(_TEXT("\nService '%s' created"), serviceName);

	push	OFFSET _serviceName
	push	OFFSET ??_C@_0BG@BDOMDCP@?6Service?5?8?$CFs?8?5created?$AA@
	call	DWORD PTR __imp__printf
	add	esp, 8

; 80   : 			}
; 81   : 			else

	jmp	SHORT $LN31@main
$LN27@main:

; 82   : 			{
; 83   : 				lastError = GetLastError();

	call	DWORD PTR __imp__GetLastError@0
	mov	DWORD PTR _lastError$[ebp], eax

; 84   : 				_tprintf(_TEXT("\nCan't create service '%s'. ErrorCode=0x%0X."),
; 85   : 						 serviceName, lastError);

	mov	eax, DWORD PTR _lastError$[ebp]
	push	eax
	push	OFFSET _serviceName
	push	OFFSET ??_C@_0CN@LJAJMOLA@?6Can?8t?5create?5service?5?8?$CFs?8?4?5Erro@
	call	DWORD PTR __imp__printf
	add	esp, 12					; 0000000cH
$LN31@main:

; 86   : 			}
; 87   : 		}
; 88   : 	}
; 89   : 
; 90   : 	if(service)

	cmp	DWORD PTR _service$[ebp], 0
	je	$LN25@main

; 91   : 	{
; 92   : 		if( StartService(service, 0, NULL) )

	push	0
	push	0
	mov	ecx, DWORD PTR _service$[ebp]
	push	ecx
	call	DWORD PTR __imp__StartServiceA@12
	test	eax, eax
	je	SHORT $LN24@main

; 93   : 		{
; 94   : 			statusBefore |= SERVICE_STARTED;

	mov	edx, DWORD PTR _statusBefore$[ebp]
	or	edx, 2
	mov	DWORD PTR _statusBefore$[ebp], edx

; 95   : 			_tprintf(_TEXT("\nService '%s' started"), serviceName);

	push	OFFSET _serviceName
	push	OFFSET ??_C@_0BG@KCIEGIHK@?6Service?5?8?$CFs?8?5started?$AA@
	call	DWORD PTR __imp__printf
	add	esp, 8

; 96   : 		}
; 97   : 		else

	jmp	SHORT $LN23@main
$LN24@main:

; 98   : 		{
; 99   : 			lastError = GetLastError();

	call	DWORD PTR __imp__GetLastError@0
	mov	DWORD PTR _lastError$[ebp], eax

; 100  : 			if(ERROR_SERVICE_ALREADY_RUNNING == lastError)

	cmp	DWORD PTR _lastError$[ebp], 1056	; 00000420H
	jne	SHORT $LN22@main

; 101  : 			{
; 102  : 				_tprintf(_TEXT("\nService '%s' already running"), serviceName);

	push	OFFSET _serviceName
	push	OFFSET ??_C@_0BO@FMFCEEJB@?6Service?5?8?$CFs?8?5already?5running?$AA@
	call	DWORD PTR __imp__printf
	add	esp, 8

; 103  : 				statusBefore |= SERVICE_RUNNING;

	mov	eax, DWORD PTR _statusBefore$[ebp]
	or	eax, 4
	mov	DWORD PTR _statusBefore$[ebp], eax

; 104  : 			}
; 105  : 			else

	jmp	SHORT $LN23@main
$LN22@main:

; 106  : 			{
; 107  : 				_tprintf(_TEXT("\nCan't start service '%s'. ErrorCode=0x%08X."),
; 108  : 							serviceName, lastError);

	mov	ecx, DWORD PTR _lastError$[ebp]
	push	ecx
	push	OFFSET _serviceName
	push	OFFSET ??_C@_0CN@NIILNDPD@?6Can?8t?5start?5service?5?8?$CFs?8?4?5Error@
	call	DWORD PTR __imp__printf
	add	esp, 12					; 0000000cH
$LN23@main:

; 109  : 			}
; 110  : 		}
; 111  : 		
; 112  : 		if( (statusBefore & SERVICE_STARTED) || (statusBefore & SERVICE_RUNNING) )

	mov	edx, DWORD PTR _statusBefore$[ebp]
	and	edx, 2
	jne	SHORT $LN19@main
	mov	eax, DWORD PTR _statusBefore$[ebp]
	and	eax, 4
	je	$LN25@main
$LN19@main:

; 113  : 		{
; 114  : 			device = CreateFile(
; 115  : 						symbolicLinkName,
; 116  : 						GENERIC_READ + GENERIC_WRITE, 0, NULL,
; 117  : 						OPEN_EXISTING, 0, NULL);

	push	0
	push	0
	push	3
	push	0
	push	0
	push	-1073741824				; c0000000H
	push	OFFSET _symbolicLinkName
	call	DWORD PTR __imp__CreateFileA@28
	mov	DWORD PTR _device$[ebp], eax

; 118  : 			
; 119  : 			if(INVALID_HANDLE_VALUE == device)

	cmp	DWORD PTR _device$[ebp], -1
	jne	SHORT $LN18@main

; 120  : 			{
; 121  : 				lastError = GetLastError();

	call	DWORD PTR __imp__GetLastError@0
	mov	DWORD PTR _lastError$[ebp], eax

; 122  : 				_tprintf(_TEXT("\nCan't open symbolik link '%s'. ErrorCode=0x%0X."),
; 123  : 							symbolicLinkName, lastError);

	mov	ecx, DWORD PTR _lastError$[ebp]
	push	ecx
	push	OFFSET _symbolicLinkName
	push	OFFSET ??_C@_0DB@HNPALFON@?6Can?8t?5open?5symbolik?5link?5?8?$CFs?8?4?5@
	call	DWORD PTR __imp__printf
	add	esp, 12					; 0000000cH

; 124  : 			}
; 125  : 			else

	jmp	$LN25@main
$LN18@main:

; 126  : 			{
; 127  : 				if(DeviceIoControl(	device,
; 128  : 									IOCTL_START,
; 129  : 									&event,
; 130  : 									2 * sizeof(HANDLE),
; 131  : 									(PVOID)0, 
; 132  : 									(DWORD)0,
; 133  : 									&counterBytes, NULL)	)

	push	0
	lea	edx, DWORD PTR _counterBytes$[ebp]
	push	edx
	push	0
	push	0
	push	8
	lea	eax, DWORD PTR _event$[ebp]
	push	eax
	push	2236416					; 00222000H
	mov	ecx, DWORD PTR _device$[ebp]
	push	ecx
	call	DWORD PTR __imp__DeviceIoControl@32
	test	eax, eax
	je	$LN16@main

; 134  : 				
; 135  : 				{
; 136  : 					_tprintf(_TEXT("\nTry to create two processes and then finish them\n"));

	push	OFFSET ??_C@_0DD@BPCEGHIK@?6Try?5to?5create?5two?5processes?5and@
	call	DWORD PTR __imp__printf
	add	esp, 4
$LN15@main:

; 137  : 					while(counterProcess < 5)

	cmp	DWORD PTR _counterProcess$[ebp], 5
	jae	$LN14@main

; 138  : 					{
; 139  : 						waitResult = WaitForMultipleObjects(2, event, FALSE, INFINITE);

	push	-1
	push	0
	lea	edx, DWORD PTR _event$[ebp]
	push	edx
	push	2
	call	DWORD PTR __imp__WaitForMultipleObjects@16
	mov	DWORD PTR _waitResult$[ebp], eax

; 140  : 						switch (waitResult - WAIT_OBJECT_0)

	mov	eax, DWORD PTR _waitResult$[ebp]
	mov	DWORD PTR tv236[ebp], eax
	cmp	DWORD PTR tv236[ebp], 0
	je	SHORT $LN11@main
	cmp	DWORD PTR tv236[ebp], 1
	je	SHORT $LN9@main
	jmp	$LN12@main
$LN11@main:

; 141  : 						{
; 142  : 							case 0:
; 143  : 								if(DeviceIoControl(	device,
; 144  : 											IOCTL_GET_INFO,
; 145  : 											(PVOID)0, 
; 146  : 											(DWORD)0,
; 147  : 											&outputBuffer,
; 148  : 											sizeof(PROCESS_NOTIFY_INFO),
; 149  : 											&counterBytes, NULL)	)

	push	0
	lea	ecx, DWORD PTR _counterBytes$[ebp]
	push	ecx
	push	12					; 0000000cH
	lea	edx, DWORD PTR _outputBuffer$[ebp]
	push	edx
	push	0
	push	0
	push	2236424					; 00222008H
	mov	eax, DWORD PTR _device$[ebp]
	push	eax
	call	DWORD PTR __imp__DeviceIoControl@32
	test	eax, eax
	je	SHORT $LN10@main

; 150  : 								{
; 151  : 									_tprintf(_TEXT("\nProcess PID = %d %s %s"), 
; 152  : 										outputBuffer.ProcessId,
; 153  : 										outputBuffer.Create ? _TEXT("started") : _TEXT("finished"));	

	movzx	ecx, BYTE PTR _outputBuffer$[ebp+8]
	test	ecx, ecx
	je	SHORT $LN38@main
	mov	DWORD PTR tv250[ebp], OFFSET ??_C@_07ELEPLNCO@started?$AA@
	jmp	SHORT $LN39@main
$LN38@main:
	mov	DWORD PTR tv250[ebp], OFFSET ??_C@_08CDECDFO@finished?$AA@
$LN39@main:
	mov	edx, DWORD PTR tv250[ebp]
	push	edx
	mov	eax, DWORD PTR _outputBuffer$[ebp+4]
	push	eax
	push	OFFSET ??_C@_0BI@OHLBBEAH@?6Process?5PID?5?$DN?5?$CFd?5?$CFs?5?$CFs?$AA@
	call	DWORD PTR __imp__printf
	add	esp, 12					; 0000000cH

; 154  : 										 counterProcess++;

	mov	ecx, DWORD PTR _counterProcess$[ebp]
	add	ecx, 1
	mov	DWORD PTR _counterProcess$[ebp], ecx
$LN10@main:

; 155  : 								}
; 156  : 								break;

	jmp	SHORT $LN12@main
$LN9@main:

; 157  : 							case 1:
; 158  : 								if(DeviceIoControl(	device,
; 159  : 											IOCTL_GET_IMAGE_INFO,
; 160  : 											(PVOID)0, 
; 161  : 											(DWORD)0,
; 162  : 											&outputImageBuffer,
; 163  : 											sizeof(IMAGE_NOTIFY_INFO),
; 164  : 											&counterBytes, NULL)	)

	push	0
	lea	edx, DWORD PTR _counterBytes$[ebp]
	push	edx
	push	131080					; 00020008H
	lea	eax, DWORD PTR _outputImageBuffer$[ebp]
	push	eax
	push	0
	push	0
	push	2236428					; 0022200cH
	mov	ecx, DWORD PTR _device$[ebp]
	push	ecx
	call	DWORD PTR __imp__DeviceIoControl@32
	test	eax, eax
	je	SHORT $LN12@main

; 165  : 								{
; 166  : 									_tprintf(_TEXT("\nModule %ws loaded at imagebase %p size: %p"), 
; 167  : 										outputImageBuffer.FullImageName,
; 168  : 										outputImageBuffer.ImageBase,
; 169  : 										 outputImageBuffer.ImageSize);	

	mov	edx, DWORD PTR _outputImageBuffer$[ebp+131076]
	push	edx
	mov	eax, DWORD PTR _outputImageBuffer$[ebp]
	push	eax
	lea	ecx, DWORD PTR _outputImageBuffer$[ebp+4]
	push	ecx
	push	OFFSET ??_C@_0CM@CBBEMDPD@?6Module?5?$CFws?5loaded?5at?5imagebase?5@
	call	DWORD PTR __imp__printf
	add	esp, 16					; 00000010H
$LN12@main:

; 170  : 								}
; 171  : 								break;
; 172  : 						}		
; 173  : 					}

	jmp	$LN15@main
$LN14@main:

; 174  : 					
; 175  : 					DeviceIoControl(	device, IOCTL_STOP,
; 176  : 									(PVOID)0, (DWORD)0,
; 177  : 									(PVOID)0, (DWORD)0,
; 178  : 									&counterBytes, NULL);

	push	0
	lea	edx, DWORD PTR _counterBytes$[ebp]
	push	edx
	push	0
	push	0
	push	0
	push	0
	push	2236420					; 00222004H
	mov	eax, DWORD PTR _device$[ebp]
	push	eax
	call	DWORD PTR __imp__DeviceIoControl@32

; 179  : 				}
; 180  : 				else

	jmp	SHORT $LN7@main
$LN16@main:

; 181  : 				{
; 182  : 					_tprintf(_TEXT("\nIOCTL_START failed. ErrorCode=0x%08X."),
; 183  : 								GetLastError());

	call	DWORD PTR __imp__GetLastError@0
	push	eax
	push	OFFSET ??_C@_0CH@NDEDPMI@?6IOCTL_START?5failed?4?5ErrorCode?$DN0@
	call	DWORD PTR __imp__printf
	add	esp, 8
$LN7@main:

; 184  : 				}
; 185  : 				CloseHandle(device);

	mov	ecx, DWORD PTR _device$[ebp]
	push	ecx
	call	DWORD PTR __imp__CloseHandle@4
$LN25@main:

; 186  : 			}
; 187  : 		}
; 188  : 	}
; 189  : 
; 190  : 	if(statusBefore & SERVICE_STARTED)

	mov	edx, DWORD PTR _statusBefore$[ebp]
	and	edx, 2
	je	SHORT $LN6@main

; 191  : 	{
; 192  : 		if(ControlService(service, SERVICE_CONTROL_STOP, &serviceStatus))

	lea	eax, DWORD PTR _serviceStatus$[ebp]
	push	eax
	push	1
	mov	ecx, DWORD PTR _service$[ebp]
	push	ecx
	call	DWORD PTR __imp__ControlService@12
	test	eax, eax
	je	SHORT $LN5@main

; 193  : 		{
; 194  : 			_tprintf(_TEXT("\nService '%s' stopped"), serviceName);

	push	OFFSET _serviceName
	push	OFFSET ??_C@_0BG@GNCMMNDN@?6Service?5?8?$CFs?8?5stopped?$AA@
	call	DWORD PTR __imp__printf
	add	esp, 8

; 195  : 		}
; 196  : 		else

	jmp	SHORT $LN6@main
$LN5@main:

; 197  : 		{
; 198  : 			lastError = GetLastError();

	call	DWORD PTR __imp__GetLastError@0
	mov	DWORD PTR _lastError$[ebp], eax

; 199  : 			_tprintf(_TEXT("\nCan't stop service '%s'. ErrorCode=0x%0X."),
; 200  : 						 serviceName, lastError);

	mov	edx, DWORD PTR _lastError$[ebp]
	push	edx
	push	OFFSET _serviceName
	push	OFFSET ??_C@_0CL@DNLIHKOL@?6Can?8t?5stop?5service?5?8?$CFs?8?4?5ErrorC@
	call	DWORD PTR __imp__printf
	add	esp, 12					; 0000000cH
$LN6@main:

; 201  : 		}
; 202  : 	}
; 203  : 	if( (statusBefore & SERVICE_INSTALLED) && (SERVICE_STOPPED == serviceStatus.dwCurrentState) )

	mov	eax, DWORD PTR _statusBefore$[ebp]
	and	eax, 1
	je	SHORT $LN3@main
	cmp	DWORD PTR _serviceStatus$[ebp+4], 1
	jne	SHORT $LN3@main

; 204  : 	{
; 205  : 		if( DeleteService(service) )

	mov	ecx, DWORD PTR _service$[ebp]
	push	ecx
	call	DWORD PTR __imp__DeleteService@4
	test	eax, eax
	je	SHORT $LN2@main

; 206  : 		{
; 207  : 			_tprintf(_TEXT("\nService '%s' deleted"), serviceName);

	push	OFFSET _serviceName
	push	OFFSET ??_C@_0BG@HLANJPHO@?6Service?5?8?$CFs?8?5deleted?$AA@
	call	DWORD PTR __imp__printf
	add	esp, 8

; 208  : 		}
; 209  : 		else

	jmp	SHORT $LN3@main
$LN2@main:

; 210  : 		{
; 211  : 			lastError = GetLastError();

	call	DWORD PTR __imp__GetLastError@0
	mov	DWORD PTR _lastError$[ebp], eax

; 212  : 			_tprintf(_TEXT("\nCan't delete service '%s'. ErrorCode=0x%0X."),
; 213  : 						 serviceName, lastError);

	mov	edx, DWORD PTR _lastError$[ebp]
	push	edx
	push	OFFSET _serviceName
	push	OFFSET ??_C@_0CN@JEBFDAOH@?6Can?8t?5delete?5service?5?8?$CFs?8?4?5Erro@
	call	DWORD PTR __imp__printf
	add	esp, 12					; 0000000cH
$LN3@main:

; 214  : 		}
; 215  : 	}
; 216  : 
; 217  : 	CloseServiceHandle(service);

	mov	eax, DWORD PTR _service$[ebp]
	push	eax
	call	DWORD PTR __imp__CloseServiceHandle@4

; 218  : 	CloseServiceHandle(scm);

	mov	ecx, DWORD PTR _scm$[ebp]
	push	ecx
	call	DWORD PTR __imp__CloseServiceHandle@4

; 219  : 	_tprintf(_TEXT("\nPress 'Enter' to exit\n"));

	push	OFFSET ??_C@_0BI@LGCNFJIL@?6Press?5?8Enter?8?5to?5exit?6?$AA@
	call	DWORD PTR __imp__printf
	add	esp, 4

; 220  : 	_gettchar();

	call	DWORD PTR __imp__getchar

; 221  : 	return lastError;

	mov	eax, DWORD PTR _lastError$[ebp]
$LN36@main:

; 222  : }

	mov	ecx, DWORD PTR __$ArrayPad$[ebp]
	xor	ecx, ebp
	call	@__security_check_cookie@4
	mov	esp, ebp
	pop	ebp
	ret	0
_main	ENDP
_TEXT	ENDS
END
